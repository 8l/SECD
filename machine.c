#include "secd.h"
#include "memory.h"
#include "env.h"
#include "secdops.h"

#include <stdlib.h>

/*
 * SECD machine
 */

secd_t * init_secd(secd_t *secd) {
    /* allocate memory chunk */
    secd->data = (cell_t *)calloc(N_CELLS, sizeof(cell_t));

    init_mem(secd, N_CELLS);

    secd->free = secd->data;
    secd->stack = secd->dump =  secd->nil;
    secd->control = secd->env =  secd->nil;

    secd->free_cells = N_CELLS - 1;
    secd->used_stack = 0;

    secd->tick = 0;

    init_env(secd);

    return secd;
}

void run_secd(secd_t *secd, cell_t *ctrl) {
    cell_t *op;

    set_control(secd, ctrl);

    while (true)  {
        op = pop_control(secd);
        assertv(op, "run: no command");
        assert_or_continue(
                atom_type(secd, op) == ATOM_OP,
                "run: not an opcode at [%ld]\n", cell_index(secd, op));

        secd_opfunc_t callee = (secd_opfunc_t) opcode_table[ op->as.atom.as.op ].fun;
        if (NULL == callee) return;  // STOP

        cell_t *ret = callee(secd);
        assertv(ret, "run: Instruction failed\n");
        drop_cell(secd, op);
        ++secd->tick;
    }
}

